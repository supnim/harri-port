{"version":3,"sources":["../src/helpers.js"],"names":[],"mappings":"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","file":"helpers.js","sourcesContent":["/* @flow */\n\nimport Path from 'path'\nimport chalk from 'chalk'\nimport Pundle from 'pundle'\nimport { createPlugin } from 'pundle-api'\nimport { createServer } from 'pundle-dev'\nimport { CompositeDisposable } from 'sb-event-kit'\n\nimport type CLI from './cli'\nimport type { Config } from './types'\n\nexport const X = '✗'\nexport const TICK = '✓'\n\n// From: goo.gl/fZA6BF\nexport function getRandomNumber(min: number, max: number): number {\n  return Math.floor(Math.random() * (max - min)) + min\n}\n\n// NOTE: The reason we are not replacing these in config is because when we then save the config\n// We'd end up with absolute paths in it, using this function in every config user function\n// will let us avoid that.\nexport function normalizeConfig(projectPath: string, givenConfig: Config): Config {\n  const config: Config = Object.assign({}, givenConfig, {\n    babel: Object.assign({}, givenConfig.babel)\n  })\n  if (config.bundleDirectory.substr(0, 1) === '.') {\n    config.bundleDirectory = Path.resolve(projectPath, config.bundleDirectory)\n  }\n  if (config.publicDirectory.substr(0, 1) === '.') {\n    config.publicDirectory = Path.resolve(projectPath, config.publicDirectory)\n  }\n  if (!config.babel || typeof config.babel !== 'object') {\n    config.babel = { plugins: [], presets: [] }\n  }\n  if (!Array.isArray(config.babel.plugins)) {\n    config.babel.plugins = []\n  } else {\n    config.babel.plugins = config.babel.plugins.slice()\n  }\n  if (!Array.isArray(config.babel.presets)) {\n    config.babel.presets = []\n  } else {\n    config.babel.presets = config.babel.presets.slice()\n  }\n  if (config.babel.presets.indexOf('babel-preset-motion') !== -1) {\n    config.babel.presets.splice(config.babel.presets.indexOf('babel-preset-motion'), 1,\n      require.resolve('babel-preset-es2015-sane'),\n      require.resolve('babel-preset-motion'))\n  }\n  config.babel.plugins = config.babel.plugins.map(function(givenEntry) {\n    if (!givenEntry) {\n      return givenEntry\n    }\n    const entry = Array.isArray(givenEntry) ? givenEntry : [givenEntry, {}]\n    if (!Path.isAbsolute(entry[0])) {\n      if (entry[0].substr(0, 1) === '.') {\n        entry[0] = Path.resolve(projectPath, entry[0])\n      } else {\n        entry[0] = Path.join(projectPath, 'node_modules', entry[0])\n      }\n    }\n    return entry\n  })\n  return config\n}\n\nexport async function getPundleInstance(\n  cli: CLI,\n  terminal: boolean,\n  projectPath: string,\n  development: boolean,\n  givenConfig: Config,\n  errorCallback: Function\n): Promise<{ pundle: Object, subscription: CompositeDisposable }> {\n  const config = normalizeConfig(projectPath, givenConfig)\n  const pundleEntry = ['./']\n\n  const subscription = new CompositeDisposable()\n  const pundle = await Pundle.create({\n    entry: pundleEntry,\n    presets: [[require.resolve('pundle-preset-default'), {\n      generator: {\n        pathType: config.pathType === 'number' ? 'number' : 'filePath',\n      },\n      reporter: {\n        log: o => cli.log(o),\n      },\n    }]],\n    components: [\n      require.resolve('pundle-plugin-dedupe'),\n      [require.resolve('pundle-plugin-npm-installer'), {\n        save: config.saveNpmModules,\n        beforeInstall(name) {\n          if (terminal) {\n            const message = `Installing ${name}`\n            cli.addSpinner(message)\n          }\n        },\n        afterInstall(name, error) {\n          if (terminal) {\n            const message = `Installing ${name}`\n            cli.removeSpinner(message)\n            // ^ To insert a new line to allow default logger of Pundle to output\n          } else if (error) {\n            errorCallback(error)\n          }\n        },\n        include: ['*.js'],\n      }],\n      [require.resolve('pundle-transformer-babel'), {\n        babelPath: require.resolve('babel-core'),\n        config: config.babel,\n        extensions: ['js'],\n      }],\n      createPlugin(function(_: Object, file: Object) {\n        if (development && file.filePath.indexOf(projectPath) === 0 && file.filePath.indexOf('node_modules') === -1) {\n          cli.log(`${chalk.dim(Path.join('$root', Path.relative(projectPath, file.filePath)))} ${chalk.green(TICK)}`)\n        }\n      }),\n    ],\n    rootDirectory: projectPath,\n    replaceVariables: {\n      'process.env.NODE_ENV': JSON.stringify(development ? 'development' : 'production'),\n    },\n  })\n  subscription.add(pundle)\n\n  if (!development) {\n    return { pundle, subscription }\n  }\n  const server = await createServer(pundle, {\n    port: config.webServerPort,\n    rootDirectory: config.publicDirectory,\n    hmrPath: '/_/bundle_hmr',\n    bundlePath: '/_/bundle.js',\n    publicPath: '/',\n    sourceMapPath: '/_/bundle.js.map',\n    redirectNotFoundToIndex: true,\n  })\n  subscription.add(server)\n\n  return { pundle, subscription }\n}\n"]}