{"version":3,"sources":["../src/index.js"],"names":[],"mappings":"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","file":"index.js","sourcesContent":["/* @flow */\n\nimport Path from 'path'\nimport invariant from 'assert'\nimport { CompositeDisposable, Disposable } from 'sb-event-kit'\nimport * as FS from './fs'\nimport CLI from './cli'\nimport Config from './config'\nimport { MotionError, ERROR_CODE } from './error'\nimport { getPundleInstance } from './helpers'\n\nclass Motion {\n  cli: CLI;\n  config: Config;\n  watching: boolean;\n  projectPath: string;\n  subscriptions: CompositeDisposable;\n\n  constructor(projectPath: string, config: Config) {\n    invariant(config instanceof Config, 'Use Motion.create instead of constructor')\n\n    this.cli = new CLI(config)\n    this.config = config\n    this.watching = false\n    this.projectPath = projectPath\n    this.subscriptions = new CompositeDisposable()\n\n    this.subscriptions.add(this.cli)\n    this.cli.onShouldBuild(async () => {\n      await this.build(false)\n    })\n    this.cli.onShouldDispose(() => {\n      this.dispose()\n    })\n  }\n  async exists(): Promise<boolean> {\n    return await FS.exists(Path.join(this.projectPath, '.motion.json'))\n  }\n  async watch(terminal: boolean = false): Promise<Disposable> {\n    if (!await this.exists()) {\n      throw new MotionError(ERROR_CODE.NOT_MOTION_APP)\n    }\n\n    if (terminal) {\n      this.cli.activate()\n    }\n    const { subscription } = await getPundleInstance(this.cli, terminal, this.projectPath, true, this.config.config, error => {\n      this.cli.log(error)\n    })\n    const disposable = new Disposable(() => {\n      this.subscriptions.delete(disposable)\n      subscription.dispose()\n    })\n\n    this.subscriptions.add(disposable)\n    return disposable\n  }\n  async build(terminal: boolean = false): Promise<void> {\n    if (!await this.exists()) {\n      throw new MotionError(ERROR_CODE.NOT_MOTION_APP)\n    }\n    let error\n    const { subscription, pundle } = await getPundleInstance(this.cli, terminal, this.projectPath, false, this.config.config, givenError => {\n      error = givenError\n    })\n    try {\n      if (error) {\n        throw error\n      }\n      const generated = await pundle.generate(null, {\n        sourceMap: false,\n      })\n      await FS.mkdir(Path.join(this.config.getPublicDirectory(), '_'))\n      await FS.writeFile(Path.join(this.config.getPublicDirectory(), '_/bundle.js'), generated.contents)\n    } finally {\n      subscription.dispose()\n    }\n  }\n  async init(): Promise<void> {\n    if (await this.exists()) {\n      throw new MotionError(ERROR_CODE.ALREADY_MOTION_APP)\n    }\n    await FS.mkdir(this.config.getBundleDirectory())\n    await FS.mkdir(this.config.getPublicDirectory())\n    await FS.copy(Path.normalize(Path.join(__dirname, '..', 'template', 'bundle')), this.config.getBundleDirectory())\n    await FS.copy(Path.normalize(Path.join(__dirname, '..', 'template', 'public')), this.config.getPublicDirectory())\n    await this.config.write()\n  }\n  dispose() {\n    this.subscriptions.dispose()\n  }\n\n  static async create(projectRoot: string): Promise<Motion> {\n    return new Motion(projectRoot, await Config.create(projectRoot))\n  }\n}\n\nmodule.exports = Motion\n"]}